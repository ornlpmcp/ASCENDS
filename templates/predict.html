{% extends "base.html" %}
{% block title %}ASCENDS â€” ML Prediction{% endblock %}
{% block content %}
<section class="panel">
  <h2>ML Prediction</h2>

  <!-- Top: choose saved model + upload CSV -->
  <div class="card">
    <div class="card-title">Model &amp; Input Data</div>
    <div class="card-body">
      <form action="/predict/run" method="post" enctype="multipart/form-data" class="toolbar inline" style="flex-wrap:wrap; gap:10px;">
        <label for="run_name"><strong>Saved Model:</strong></label>
        <select id="run_name" name="run_name" class="select" style="min-width:260px;">
          <option value="">(choose a run)</option>
          {% for r in saved_runs or [] %}
            {# Normalize run name across dict/object/string #}
            {% if r is mapping %}
              {% set run_name = r['name'] %}
            {% else %}
              {% set run_name = (r.name if (r is defined and r is not string and (r.name is defined)) else r) %}
            {% endif %}
            {% set sel = 'selected' if selected_run and selected_run == run_name else '' %}
            <option value="{{ run_name }}" {{ sel }}>{{ run_name }}</option>
          {% endfor %}
        </select>

        <label for="csvfile"><strong>Input CSV:</strong></label>
        <input id="csvfile" type="file" name="csvfile" accept=".csv">

        <button class="btn btn-sm" type="submit">Run Predict</button>
      </form>

      {% if predict_errors %}
        <div class="subcard" style="color:#a33; margin-top:10px;">
          <strong>Errors:</strong>
          <ul class="list">
            {% for e in predict_errors %}<li>{{ e }}</li>{% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if upload_info %}
        <div class="subcard" style="margin-top:10px;">
          <strong>Step P1:</strong> Received
          <ul class="list" style="margin-top:6px;">
            <li>Run = <code>{{ selected_run }}</code></li>
            <li>File = <code>{{ upload_info.filename }}</code> ({{ upload_info.bytes }} bytes)</li>
          </ul>
          <em>Round-trip OK. Next step will validate schema and run predictions.</em>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Results placeholder area (P2/P3 will fill this) -->
  <div class="card" style="margin-top:12px;">
    <div class="card-title">Results</div>
    <div class="card-body">
      {% if rows_read is not none %}
        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
          <span style="display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc;">
            <strong>Read:</strong> {{ rows_read }}
          </span>
          <span style="display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc;">
            <strong>Used:</strong> {{ rows_used }}
          </span>
          <span style="display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc;">
            <strong>Dropped:</strong> {{ rows_dropped }}
          </span>
          {% if download_csv_url %}
            <a class="btn btn-sm" href="{{ download_csv_url }}" style="margin-left:auto;">Download CSV</a>
          {% endif %}
        </div>
      {% endif %}

      <div style="overflow:auto; max-height:360px; border:1px solid #e5e7eb; border-radius:8px;">
        {% if predict_preview_html %}
          {% autoescape false %}{{ predict_preview_html }}{% endautoescape %}
        {% elif predict_preview_headers and predict_preview_rows %}
          <table class="table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                {% for h in predict_preview_headers %}
                  <th style="text-align:left; border-bottom:1px solid #e5e7eb; padding:6px 8px;">{{ h }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in predict_preview_rows %}
                <tr>
                  {% for cell in row %}
                    <td style="border-bottom:1px solid #f0f2f5; padding:6px 8px;">{{ cell }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div style="padding:10px;"><em>No results yet.</em></div>
        {% endif %}
      </div>

      {# download buttons shown in the stats strip above; keep Excel spot for future #}
      {% if download_xlsx_url %}
        <div class="toolbar" style="margin-top:10px;">
          <a class="btn btn-sm" href="{{ download_xlsx_url }}">Download Excel</a>
        </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
