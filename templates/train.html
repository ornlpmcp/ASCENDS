{% extends "base.html" %}
{% block title %}ASCENDS — ML Performance Training &amp; Test{% endblock %}

{% block content %}
<div class="train-page">
  <section class="panel">
    <h2>ML Performance Training &amp; Test</h2>

    <!-- Top row: 15% | 15% | 70% -->
    <div class="train-top">

      <!-- All Columns -->
      <div class="pane">
        <div class="card">
          <div class="card-title">All Columns</div>
          <div class="card-body train-pane-scroll">
            <form action="/train/select" method="post">
              {% if ws_id %}<input type="hidden" name="ws_id" value="{{ ws_id }}">{% endif %}

              <div class="toolbar inline">
                <button class="btn btn-sm" type="submit" name="action" value="select_all" {% if not ws_id %}disabled{% endif %}>Select all</button>
                <button class="btn btn-sm" type="submit" name="action" value="select_none" {% if not ws_id %}disabled{% endif %}>Select none</button>
              </div>

              <div class="subcard">
                <strong>Columns ({{ all_columns|length if all_columns else 0 }})</strong>
                <div class="mt-8">
                  <ul class="list">
                    {% for c in all_columns or [] %}
                      <li>
                        <label>
                          <input type="checkbox" name="columns" value="{{ c }}"
                                 {% if selected and c in selected %}checked{% endif %}
                                 {% if not ws_id %}disabled{% endif %}>
                          {{ c }}
                        </label>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>

              <div class="mt-8">
                <label for="target-choice"><strong>Target choice:</strong></label>
                <select id="target-choice" name="target_choice" class="select" {% if not ws_id %}disabled{% endif %}>
                  {% for c in all_columns or [] %}
                    <option value="{{ c }}" {% if target is defined and target == c %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm" type="submit" name="action" value="set_target" {% if not ws_id %}disabled{% endif %}>Set target</button>
              </div>

              <div class="toolbar inline mt-8">
                <button class="btn btn-sm" type="submit" name="action" value="to_inputs" {% if not ws_id %}disabled{% endif %}>→ Use selected as inputs</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Input / Target -->
      <div class="pane">
        <div class="card">
          <div class="card-title">Input / Target</div>
          <div class="card-body train-pane-scroll">
            <div><strong>Target:</strong> {{ target if target else "(not set)" }}</div>

            <form action="/train/select" method="post" class="mt-8">
              {% if ws_id %}<input type="hidden" name="ws_id" value="{{ ws_id }}">{% endif %}
              <div><strong>Inputs ({{ inputs|length if inputs else 0 }}):</strong></div>
              {% if inputs %}
                <ul class="list">
                  {% for c in inputs %}
                    <li><label><input type="checkbox" name="rm_inputs" value="{{ c }}"> {{ c }}</label></li>
                  {% endfor %}
                </ul>
                <button class="btn btn-sm" type="submit" name="action" value="remove_inputs" {% if not ws_id %}disabled{% endif %}>Remove selected</button>
              {% else %}
                <em>No inputs selected.</em>
              {% endif %}
            </form>
          </div>
        </div>
      </div>

      <!-- Accuracy Test (placeholder for now) -->
      <div class="pane">
        <div class="card">
          <div class="card">
            <div class="card-title">Accuracy Test</div>
            <div class="card-body train-accuracy-body">
              {% set current_task = (train_params['task'] if train_params and 'task' in train_params else 'r') %}
              {% set current_seed = (train_params['seed'] if train_params and 'seed' in train_params else 42) %}
              {% set current_resample = (train_params['resample'] if train_params and 'resample' in train_params else False) %}

              <form action="/train/run" method="post" class="acc-toolbar">
                {% if ws_id %}<input type="hidden" name="ws_id" value="{{ ws_id }}">{% endif %}

                <strong>Task:</strong>
                <label>
                  <input type="radio" name="task" value="r"
                         {% if not ws_id %}disabled{% endif %}
                         {% if current_task == 'r' %}checked{% endif %}> Regression
                </label>
                <label>
                  <input type="radio" name="task" value="c"
                         {% if not ws_id %}disabled{% endif %}
                         {% if current_task == 'c' %}checked{% endif %}> Classification
                </label>

                <strong>Model:</strong>
                <select class="select" name="model" {% if not ws_id %}disabled{% endif %}>
                  {% set current_model = (train_params['model'] if train_params and 'model' in train_params else 'rf') %}
                  <option value="rf"   {% if current_model=='rf' %}selected{% endif %}>RandomForest</option>
                  <option value="xgb"  {% if current_model=='xgb' %}selected{% endif %}>XGBoost</option>
                  <option value="hgb"  {% if current_model=='hgb' %}selected{% endif %}>HistGradientBoost</option>
                  <option value="svr"  {% if current_model=='svr' %}selected{% endif %}>SVR</option>
                  <option value="knn"  {% if current_model=='knn' %}selected{% endif %}>KNN</option>
                  <option value="linear" {% if current_model=='linear' %}selected{% endif %}>Linear</option>
                  <option value="ridge"  {% if current_model=='ridge' %}selected{% endif %}>Ridge</option>
                  <option value="lasso"  {% if current_model=='lasso' %}selected{% endif %}>Lasso</option>
                  <option value="elastic" {% if current_model=='elastic' %}selected{% endif %}>ElasticNet</option>
                </select>

                <strong>Test size:</strong>
                {% set current_ts = (train_params['test_size'] if train_params and 'test_size' in train_params else 0.20) %}
                <input class="input" type="number" name="test_size" min="0.05" max="0.5" step="0.05"
                       value="{{ '%.2f'|format(current_ts|float) }}" {% if not ws_id %}disabled{% endif %}>

                <strong>Tuning:</strong>
                {% set current_tune = (train_params['tune'] if train_params and 'tune' in train_params else 'off') %}
                <select class="select" name="tune" {% if not ws_id %}disabled{% endif %}>
                  <option value="off"    {% if current_tune=='off' %}selected{% endif %}>off</option>
                  <option value="quick"  {% if current_tune=='quick' %}selected{% endif %}>quick</option>
                  <option value="intense" {% if current_tune=='intense' %}selected{% endif %}>intense</option>
                  <option value="optuna" {% if current_tune=='optuna' %}selected{% endif %}>optuna</option>
                  <option value="bayes"  {% if current_tune=='bayes' %}selected{% endif %}>bayes</option>
                </select>

                <strong>Seed:</strong>
                <input class="input" type="number" name="seed" min="0" step="1"
                       value="{{ current_seed }}" {% if not ws_id %}disabled{% endif %}>

                <label title="Use a fresh time-based seed each run">
                  <input type="checkbox" name="resample" {% if current_resample %}checked{% endif %}
                         {% if not ws_id %}disabled{% endif %}>
                  Resample each run
                </label>

                <button class="btn btn-sm" type="submit" {% if not ws_id or not target or not inputs %}disabled{% endif %}>
                  Train
                </button>
              </form>

              {% if train_error %}
                <div class="subcard" style="color:#a33;"><strong>Error:</strong> {{ train_error }}</div>
              {% endif %}

              {% if false and metrics_train and metrics_test %}
                <div class="subcard">
                  <strong>Metrics</strong>
                  <div class="mt-8">
                    <ul class="list">
                      <li><em>Train</em> — R²={{ "%.4f"|format(metrics_train["R2"]) }}, MAE={{ "%.4f"|format(metrics_train["MAE"]) }}, RMSE={{ "%.4f"|format(metrics_train["RMSE"]) }}</li>
                      <li><em>Test</em>  — R²={{ "%.4f"|format(metrics_test["R2"]) }}, MAE={{ "%.4f"|format(metrics_test["MAE"]) }}, RMSE={{ "%.4f"|format(metrics_test["RMSE"]) }}</li>
                    </ul>
                  </div>
                  <em>Step B complete — training ran and metrics are computed. Next: render the parity PNG.</em>
                </div>
              {% endif %}

              <div class="plot-box">
                {% if parity_img_url %}
                  <img src="{{ parity_img_url }}" alt="Parity plot">
                {% else %}
                  <em>Parity plot with embedded metrics will render here after training.</em>
                {% endif %}
              </div>

              <div class="save-strip">
                <label for="save-name"><strong>Name:</strong></label>
                <input id="save-name" class="input" type="text" placeholder="e.g., my_best_model" disabled>
                <button class="btn btn-sm" disabled>Save Model</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /train-top -->

    <!-- Bottom row (placeholders) -->
    <div class="train-bottom">
      <div class="pane">
        <div class="card">
          <div class="card-title">Test History</div>
          <div class="card-body">
            <em>Recent results for the current model setup will appear here.</em>
          </div>
        </div>
      </div>
      <div class="pane">
        <div class="card">
          <div class="card-title">ML Models</div>
          <div class="card-body">
            <em>Saved models will appear here with metrics, inputs, target, and actions.</em>
          </div>
        </div>
      </div>
    </div>

  </section>
</div>
{% endblock %}
